name: Pull on server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run_pull:
    name: Pull latest changes
    runs-on: ubuntu-latest
    
    steps:
    - name: Install SSH keys
      run: |
        install -m 700 -d $HOME/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > $HOME/.ssh/id_rsa
        chmod 600 $HOME/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> $HOME/.ssh/known_hosts
        chmod 644 $HOME/.ssh/known_hosts

    - name: Connect and pull changes
      run: |
        ssh -o StrictHostKeyChecking=yes \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd '${{ secrets.WORK_DIR }}' && \
             git checkout '${{ secrets.MAIN_BRANCH }}' && \
             git pull --ff-only"

    - name: Cleanup SSH keys
      run: rm -rf $HOME/.ssh
